# Release v2.0.10-beta.2.1

⚠️ **베타 버전**: 이 버전은 테스트 중이며 프로덕션 환경에서 사용 시 주의가 필요합니다.

## 버그 수정

### 🔧 Room 0 조명 제어 오류 수정
- **문제**: light_0_0, light_0_1 등 0번 방 조명 엔티티가 제어되지 않던 문제
- **원인**: `generate_command` 함수에서 LIGHTCUTOFF 타입 처리 시 `REV_DT_MAP`에 없는 키를 참조하여 KeyError 발생
- **해결**:
  - `dest_dev`와 `dest_room` 초기화를 제거하고 각 device type 조건문 안에서 설정
  - LIGHTCUTOFF 타입은 `REV_DT_MAP`을 참조하지 않고 직접 값 설정 (0x0E, 0xFF)
  - 일반 조명(LIGHT)과 일괄소등(LIGHTCUTOFF)을 명확히 구분하여 처리

### 🔧 일괄소등 엔티티 생성 오류 수정
- **문제**: 일괄소등 버튼을 눌러도 `light.kocom_lightcutoff_cutoff_0_0` 엔티티가 생성되지 않음
- **원인**: `gateway.py`의 `on_device_state`에서 LIGHTCUTOFF 타입이 `allow_insert` 체크에 포함되지 않음
- **해결**:
  - `DeviceType.LIGHTCUTOFF`를 `allow_insert` 조건에 추가
  - LIGHTCUTOFF는 항상 `allow_insert=True`로 강제하여 엔티티 등록 보장

### 🔧 강제 재등록 문제 수정 (beta.2)
- **문제**: beta.1에서 매 패킷마다 LIGHTCUTOFF 엔티티를 registry에서 삭제하고 재등록하는 버그
- **원인**: 일괄소등 엔티티가 생성되지 않는 문제 해결 과정에서 과도한 수정 적용
- **해결**:
  - 강제 재등록 코드 제거
  - LIGHTCUTOFF는 최초 1회만 등록되고 이후에는 정상적으로 상태 업데이트만 수행
  - 불필요한 오버헤드 제거 및 안정성 향상

### 🔧 일괄소등 동작 안되는 문제 수정 (beta.2.1) ⭐
- **문제**: 일괄소등 엔티티는 생성되지만 켜기/끄기 명령이 타임아웃되어 동작하지 않음
- **원인**: 일괄소등은 broadcast 명령이라 벽패드에서 confirmation을 보내지 않음
- **현상**:
  - Home Assistant → 벽패드: 명령 전송 성공 ✅
  - 벽패드 → Home Assistant: 응답 없음 ❌
  - 1초 대기 → 타임아웃 → 3회 재시도 → 실패 표시
- **해결**:
  - LIGHTCUTOFF는 confirmation을 기다리지 않도록 수정
  - `build_expectation`에서 LIGHTCUTOFF 타입은 즉시 성공 처리 (timeout=0.0초)
  - 명령 전송 후 즉시 완료, 타임아웃 경고 제거

## 개선 사항

### 🐛 디버그 로깅 강화 (beta.2)
- 조명 패킷 수신 시 상세 로그 출력 (room, command, payload)
- 일괄소등 감지 시 로그 출력
- **일괄소등 명령 생성 디버깅 로그 추가**:
  - action (turn_on/turn_off)
  - command byte (0x65/0x66)
  - data payload
  - 최종 생성된 패킷 hex dump
- Registry upsert 결과 로그 추가 (is_new, changed 상태 추적)

### 📦 영향받는 컴포넌트
- `controller.py`: `generate_command` 및 `build_expectation` 메서드 수정
  - LIGHTCUTOFF: dest_dev=0x0E, dest_room=0xFF 직접 설정
  - LIGHTCUTOFF 명령 생성 시 상세 디버그 로그 출력
  - **LIGHTCUTOFF는 confirmation 대기하지 않음 (즉시 성공 처리)**
  - LIGHT/OUTLET/THERMOSTAT/AIRCONDITIONER/VENTILATION/GASVALVE: REV_DT_MAP 사용
  - ELEVATOR: 기존 로직 유지
- `gateway.py`: LIGHTCUTOFF 타입 처리 최적화
  - allow_insert 체크에 LIGHTCUTOFF 추가
  - 강제 재등록 코드 제거 (안정성 향상)
  - Registry 상태 추적 로그 추가

## 테스트 필요 항목

다음 엔티티들이 정상 작동하는지 확인:
- ✅ `light.kocom_light_light_0_0` (0번 방 조명 1)
- ✅ `light.kocom_light_light_0_1` (0번 방 조명 2)
- ✅ `light.kocom_lightcutoff_cutoff_0_0` (일괄소등 - 엔티티 생성 및 **동작 확인**)

**일괄소등 동작 테스트:**
1. 엔티티 생성 확인: 벽패드에서 일괄소등 버튼 1회 누르기
2. **동작 확인**: Home Assistant에서 일괄소등 엔티티 켜기/끄기 → **타임아웃 없이 즉시 동작**
3. 로그 확인: debug 레벨에서 LIGHTCUTOFF 패킷 생성 로그 확인

## 패킷 형식 검증 (beta.2.1)

**실제 수신 패킷 (벽패드 → HA):**
```
Light packet received: room=0xff, command=0x65, payload=0000000000000000
```

**생성된 패킷 (HA → 벽패드):**
```
aa5530bc000eff010065000000000000000005f0d0d

분해:
aa55  - 프리픽스
30bc  - type_bytes
00    - padding
0e    - dest_dev (Light = 0x0E) ✅
ff    - dest_room (cutoff) ✅
01    - src_dev (HA) ✅
00    - src_room ✅
65    - command (turn on) ✅
0000000000000000 - data (8 bytes) ✅
5f    - checksum ✅
0d0d  - 서픽스 ✅
```

**결론**: 패킷 형식 완벽하게 일치 ✅

## 변경 이력

### beta.2.1 (현재) ⭐
- **일괄소등 동작 안되는 문제 수정** (confirmation 대기 제거)
- 패킷 형식 검증 및 문서화
- 릴리즈 노트를 `release_notes/` 폴더로 구조화

### beta.2
- 강제 재등록 버그 수정
- 일괄소등 명령 생성 디버깅 로그 추가
- Registry 상태 추적 로그 추가

### beta.1
- Room 0 조명 제어 오류 수정
- 일괄소등 엔티티 생성 오류 수정
- 기본 디버그 로깅 추가

## 설치 방법

이 베타 버전을 테스트하려면:
1. HACS에서 "사용자 정의 저장소" 추가
2. 또는 수동으로 `custom_components/kocom_wallpad` 폴더 교체
3. Home Assistant 재시작
4. **로그 레벨을 debug로 설정하여 상세 로그 확인 권장**:
   ```yaml
   logger:
     default: info
     logs:
       custom_components.kocom_wallpad: debug
   ```

## 알려진 제한사항

- 일괄소등 명령은 벽패드에서 confirmation을 보내지 않아 실제 동작 여부를 즉시 확인할 수 없습니다.
- 실제 조명 상태는 각 조명에서 보내는 상태 업데이트 패킷으로 확인됩니다.
